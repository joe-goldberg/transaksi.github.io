<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Finance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui; margin: 16px; background: #f5f5f7; }
    .card { background: #fff; padding: 14px; border-radius: 12px; margin-bottom:16px; }
    input, select { width:100%; padding:10px; margin:6px 0; border:1px solid #ccc; border-radius:8px; }
    button { width:100%; padding:12px; background:#007bff; color:white; border-radius:8px; border:none; }
    table { width:100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding:6px 4px; border-bottom:1px solid #eee; }
    th { text-transform: uppercase; font-size:10px; color:#666; }
    .amount { text-align:right; }
    .tag { padding:2px 6px; border-radius:999px; font-size:10px; color:#000; }
    .tag-income { background:#d4f8e8; }
    .tag-expense { background:#ffd7dd; }
    .tag-saving { background:#dee7ff; }
    .tag-investment { background:#fff1cc; }
  </style>
</head>

<body>

<h1>Family Finance Dashboard</h1>

<div class="card">
  <h2>Input Transaction</h2>

  <label>Date</label>
  <input type="date" id="dateInput">

  <label>Type</label>
  <select id="typeInput" onchange="updateCategories()">
    <option value="">Choose type</option>
    <option value="income">Income</option>
    <option value="expense">Expense</option>
    <option value="saving">Saving</option>
    <option value="investment">Investment</option>
  </select>

  <label>Category</label>
  <select id="categoryInput"></select>

  <label>Amount</label>
  <input type="number" id="amountInput">

  <button onclick="saveData()">Save</button>
</div>

<div class="card">
  <h2>Summary</h2>
  <input type="month" id="monthFilter" onchange="updateDashboard()">
  <p>Income: <span id="sumIncome">0</span></p>
  <p>Expense: <span id="sumExpense">0</span></p>
  <p>Saving: <span id="sumSaving">0</span></p>
  <p>Investment: <span id="sumInvestment">0</span></p>
  <h3 id="netCashText">Net cash: 0</h3>
</div>

<div class="card">
  <h2>Expense by Category</h2>
  <canvas id="expenseChart" height="220"></canvas>
</div>

<div class="card">
  <h2>Transactions</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Category</th><th class="amount">Amount</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div class="card">
  <h2>Export CSV</h2>
  <button onclick="exportCSV()">Download CSV</button>
</div>

<script>
const STORAGE_KEY = "familyFinanceData_v1";

const GOOGLE_SHEETS_WEBAPP_URL = "YOUR_WEB_APP_URL_HERE";  // ⬅️ GANTI DI SINI

const categories = {
  income: ["salary", "side hustle"],
  expense: ["bath care", "fnb", "belanja masak", "utilities", "transport", "food"],
  saving: ["home", "pension", "health"],
  investment: ["saham", "SBN", "others"]
};

let expenseChart = null;

function getData() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}

function setData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function updateCategories() {
  const type = document.getElementById("typeInput").value;
  const catSelect = document.getElementById("categoryInput");
  catSelect.innerHTML = "";

  if (categories[type]) {
    categories[type].forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      catSelect.appendChild(opt);
    });
  }
}

async function syncToGoogleSheets(entry) {
  try {
    await fetch(GOOGLE_SHEETS_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(entry)
    });
  } catch (e) {
    console.log("Sync failed:", e);
  }
}

function saveData() {
  const entry = {
    date: document.getElementById("dateInput").value,
    type: document.getElementById("typeInput").value,
    category: document.getElementById("categoryInput").value,
    amount: Number(document.getElementById("amountInput").value)
  };

  if (!entry.date || !entry.type || !entry.category || !entry.amount) {
    alert("Fill all fields");
    return;
  }

  // save locally
  const data = getData();
  data.push(entry);
  setData(data);

  // sync to Google Sheets
  syncToGoogleSheets(entry);

  alert("Saved");
  updateDashboard();
}

function getFilteredData() {
  const data = getData();
  const month = document.getElementById("monthFilter").value;
  if (!month) return data;
  return data.filter(x => x.date.startsWith(month));
}

function updateSummary() {
  const data = getFilteredData();
  let income=0, expense=0, saving=0, invest=0;

  data.forEach(d => {
    if (d.type === "income") income += d.amount;
    if (d.type === "expense") expense += d.amount;
    if (d.type === "saving") saving += d.amount;
    if (d.type === "investment") invest += d.amount;
  });

  document.getElementById("sumIncome").innerText = income;
  document.getElementById("sumExpense").innerText = expense;
  document.getElementById("sumSaving").innerText = saving;
  document.getElementById("sumInvestment").innerText = invest;

  const net = income - (expense + saving + invest);
  document.getElementById("netCashText").innerText = "Net cash: " + net;
}

function updateTable() {
  const data = getFilteredData();
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  data.sort((a,b) => a.date < b.date ? 1 : -1);

  data.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.date}</td>
      <td><span class="tag tag-${d.type}">${d.type}</span></td>
      <td>${d.category}</td>
      <td class="amount">${d.amount}</td>
    `;
    tbody.appendChild(tr);
  });
}

function updateChart() {
  const data = getFilteredData().filter(d => d.type === "expense");
  const byCat = {};
  data.forEach(d => byCat[d.category] = (byCat[d.category] || 0) + d.amount);

  const labels = Object.keys(byCat);
  const values = Object.values(byCat);

  const ctx = document.getElementById("expenseChart");

  if (expenseChart) expenseChart.destroy();

  expenseChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ data: values }] },
    options: { plugins: { legend: { display:false }}, scales:{ y:{beginAtZero:true}} }
  });
}

function exportCSV() {
  const data = getData();
  let csv = "date,type,category,amount\n";
  csv += data.map(d => `${d.date},${d.type},${d.category},${d.amount}`).join("\n");

  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "family_finance.csv";
  a.click();
}

function updateDashboard() {
  updateSummary();
  updateTable();
  updateChart();
}

window.onload = () => {
  const today = new Date().toISOString().slice(0,10);
  document.getElementById("dateInput").value = today;
  document.getElementById("monthFilter").value = today.slice(0,7);
  updateCategories();
  updateDashboard();
};
</script>

</body>
</html>
