<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Finance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 16px; background: #f5f5f7; }
    h1 { font-size: 22px; margin-bottom: 8px; }
    h2 { font-size: 18px; margin-bottom: 8px; }
    .card { background:#fff; border-radius:12px; padding:14px; margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,0.04); }
    label { font-size:13px; display:block; margin-top:8px; margin-bottom:2px; }
    input, select { width:100%; padding:10px; margin:2px 0 6px; border-radius:10px; border:1px solid #d0d0d5; font-size:14px; box-sizing:border-box; }
    button { width:100%; padding:12px; background:#007bff; color:#fff; border-radius:10px; border:none; font-size:15px; font-weight:600; margin-top:8px; }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { padding:6px 4px; border-bottom:1px solid #eee; }
    th { font-weight:600; font-size:11px; text-transform:uppercase; color:#666; }
    .amount { text-align:right; }
    .tag { display:inline-block; padding:2px 6px; border-radius:999px; font-size:10px; text-transform:capitalize; }
    .tag-income { background:#d4f8e8; }
    .tag-expense { background:#ffd7dd; }
    .tag-saving { background:#dee7ff; }
    .tag-investment { background:#fff1cc; }
    @media (min-width:768px) { body { max-width:600px; margin:16px auto; } }
  </style>
</head>

<body>

<h1>Family Finance Dashboard</h1>

<div class="card">
  <h2>Input Transaction</h2>

  <label for="dateInput">Date</label>
  <input type="date" id="dateInput">

  <label for="typeInput">Type</label>
  <select id="typeInput" onchange="updateCategories()">
    <option value="">Choose type</option>
    <option value="income">Income</option>
    <option value="expense">Expense</option>
    <option value="saving">Saving</option>
    <option value="investment">Investment</option>
  </select>

  <label for="categoryInput">Category</label>
  <select id="categoryInput"></select>

  <label for="amountInput">Amount</label>
  <input type="number" id="amountInput" placeholder="Enter amount">

  <label for="NotesInput">Notes</label>
  <input type="text" id="notesInput" placeholder="Optional notes (e.g. bought soap)">


  <button onclick="saveData()">Save</button>
</div>

<div class="card">
  <h2>Summary</h2>
  <input type="month" id="monthFilter" onchange="updateDashboard()">
  <p>Income: <span id="sumIncome">0</span></p>
  <p>Expense: <span id="sumExpense">0</span></p>
  <p>Saving: <span id="sumSaving">0</span></p>
  <p>Investment: <span id="sumInvestment">0</span></p>
  <h3 id="netCashText">Net cash: 0</h3>
</div>

<div class="card">
  <h2>Expense by Category</h2>
  <canvas id="expenseChart" height="220"></canvas>
</div>

<div class="card">
  <h2>Transactions</h2>
  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Category</th>
          <th class="amount">Amount</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<div class="card">
  <h2>Export CSV</h2>
  <button onclick="exportCSV()">Download CSV</button>
</div>

<script>
const STORAGE_KEY = "familyFinanceData_v1";

// GANTI dengan URL Web App dari Apps Script-mu
const GOOGLE_SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxJ9BbP8bzjbjUi9JF5zlB1okwKj22tprcCWsdpOcm95tHJFV3YlSzeoeIVGhUY-oqcdQ/exec";

const categories = {
  income: ["salary", "side hustle"],
  expense: ["bath care", "fnb", "belanja masak", "utilities", "transport", "food"],
  saving: ["home", "pension", "health"],
  investment: ["saham", "SBN", "others"]
};

let expenseChart = null;

// ====== Local Storage Helpers ======
function getData() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}
function setData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// ====== UI Helpers ======
function updateCategories() {
  const type = document.getElementById("typeInput").value;
  const catSelect = document.getElementById("categoryInput");
  catSelect.innerHTML = "";

  if (categories[type]) {
    categories[type].forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      catSelect.appendChild(opt);
    });
  }
}

function formatMoney(num) {
  if (!num) return "0";
  return new Intl.NumberFormat("id-ID", { maximumFractionDigits: 0 }).format(num);
}

// ====== Sync to Google Sheets (Write) ======
async function syncToGoogleSheets(entry) {
  if (!GOOGLE_SHEETS_WEBAPP_URL || GOOGLE_SHEETS_WEBAPP_URL === "PASTE_WEB_APP_URL_HERE") {
    console.log("Google Sheets URL not set, skip sync");
    return;
  }
  try {
    await fetch(GOOGLE_SHEETS_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(entry)
    });
  } catch (e) {
    console.log("Sync to Sheets failed:", e);
  }
}

// ====== Sync from Google Sheets (Read) ======
async function loadFromGoogleSheets() {
  if (!GOOGLE_SHEETS_WEBAPP_URL || GOOGLE_SHEETS_WEBAPP_URL === "PASTE_WEB_APP_URL_HERE") {
    console.log("Google Sheets URL not set, skip load");
    updateDashboard();
    return;
  }

  try {
    const res = await fetch(GOOGLE_SHEETS_WEBAPP_URL); // doGet
    const data = await res.json();

    // data format dari Apps Script: [{date, type, category, amount}, ...]
    if (Array.isArray(data)) {
      setData(data);
    }
  } catch (e) {
    console.log("Load from Sheets failed:", e);
  }

  updateDashboard();
}

// ====== Save Data ======
function saveData() {
  const date = document.getElementById("dateInput").value;
  const type = document.getElementById("typeInput").value;
  const category = document.getElementById("categoryInput").value;
  const amount = Number(document.getElementById("amountInput").value);

  if (!date || !type || !category || !amount) {
    alert("Please complete all fields");
    return;
  }

  //const entry = { date, type, category, amount };
  const notes = document.getElementById("notesInput").value || "";

  const entry = {
    date,
    type,
    category,
    amount,
    notes
  };
  

  // local
  const data = getData();
  data.push(entry);
  setData(data);

  // remote
  syncToGoogleSheets(entry);

  document.getElementById("amountInput").value = "";
  document.getElementById("notesInput").value = "";
  alert("Saved");
  updateDashboard();
}

// ====== Dashboard: Filter, Summary, Table, Chart ======
function getFilteredData() {
  const data = getData();
  const month = document.getElementById("monthFilter").value;
  if (!month) return data;
  return data.filter(x => x.date && x.date.startsWith(month));
}

function updateSummary() {
  const data = getFilteredData();
  let income=0, expense=0, saving=0, invest=0;

  data.forEach(d => {
    if (d.type === "income") income += d.amount;
    if (d.type === "expense") expense += d.amount;
    if (d.type === "saving") saving += d.amount;
    if (d.type === "investment") invest += d.amount;
  });

  document.getElementById("sumIncome").innerText = formatMoney(income);
  document.getElementById("sumExpense").innerText = formatMoney(expense);
  document.getElementById("sumSaving").innerText = formatMoney(saving);
  document.getElementById("sumInvestment").innerText = formatMoney(invest);

  const net = income - (expense + saving + invest);
  document.getElementById("netCashText").innerText = "Net cash: " + formatMoney(net);
}

function updateTable() {
  const data = getFilteredData();
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  if (data.length === 0) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 4;
    td.textContent = "No data for this period.";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  data.sort((a,b) => a.date < b.date ? 1 : -1);

  data.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.date}</td>
      <td><span class="tag tag-${d.type}">${d.type}</span></td>
      <td>${d.category}</td>
      <td class="amount">${formatMoney(d.amount)}</td>
      <td>${d.notes || ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

function updateChart() {
  const data = getFilteredData().filter(d => d.type === "expense");
  const byCat = {};
  data.forEach(d => { byCat[d.category] = (byCat[d.category] || 0) + d.amount; });

  const labels = Object.keys(byCat);
  const values = Object.values(byCat);

  const ctx = document.getElementById("expenseChart").getContext("2d");
  if (expenseChart) expenseChart.destroy();

  if (labels.length === 0) {
    expenseChart = new Chart(ctx, {
      type: "bar",
      data: { labels: ["No data"], datasets: [{ data: [0] }] },
      options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });
    return;
  }

  expenseChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ data: values }] },
    options: {
      plugins: {
        legend: { display:false },
        tooltip: {
          callbacks: {
            label: ctx => formatMoney(ctx.parsed.y)
          }
        }
      },
      scales: { y: { beginAtZero:true } }
    }
  });
}

function updateDashboard() {
  updateSummary();
  updateTable();
  updateChart();
}

// ====== Init ======
window.onload = () => {
  const today = new Date().toISOString().slice(0,10);
  document.getElementById("dateInput").value = today;
  document.getElementById("monthFilter").value = today.slice(0,7);
  updateCategories();

  // pertama kali load: tarik data dari Sheets, lalu update dashboard
  loadFromGoogleSheets();
};
</script>

</body>
</html>
